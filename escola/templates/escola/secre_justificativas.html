{% extends 'escola/base_secretaria.html' %}
{% load static %}

{% block title %}Justificativas de Faltas - Secretaria{% endblock %}
{% block nav_justificativas %}active{% endblock %}
{% block page_title %}Justificativas de Faltas{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }
    .page-header h2 {
        font-size: 20px;
        color: #333;
        margin: 0;
    }
    .badge-pendentes {
        background: #fff3cd;
        color: #856404;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
    }
    .filters-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 24px;
    }
    .filters-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1;
        min-width: 200px;
    }
    .filter-group label {
        font-size: 13px;
        font-weight: 600;
        color: #555;
    }
    .filter-group input,
    .filter-group select {
        padding: 10px 14px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }
    .btn-filter {
        padding: 10px 20px;
        background: #003366;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }
    .btn-filter:hover {
        background: #002244;
    }
    .btn-limpar {
        padding: 10px 20px;
        background: #f0f0f0;
        color: #333;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
    }
    .justificativas-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .justificativas-table {
        width: 100%;
        border-collapse: collapse;
    }
    .justificativas-table th,
    .justificativas-table td {
        padding: 14px 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    .justificativas-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
        font-size: 13px;
    }
    .justificativas-table td {
        font-size: 14px;
        color: #555;
    }
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-pendente {
        background: #fff3cd;
        color: #856404;
    }
    .status-aprovada {
        background: #d4edda;
        color: #155724;
    }
    .status-rejeitada {
        background: #f8d7da;
        color: #721c24;
    }
    .action-btns {
        display: flex;
        gap: 8px;
    }
    .btn-aprovar {
        padding: 6px 12px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
    }
    .btn-aprovar:hover {
        background: #218838;
    }
    .btn-rejeitar {
        padding: 6px 12px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
    }
    .btn-rejeitar:hover {
        background: #c82333;
    }
    .btn-ver-doc {
        padding: 6px 12px;
        background: #0066cc;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
    }
    .empty-state {
        text-align: center;
        padding: 60px;
        color: #666;
    }
    .empty-state svg {
        margin-bottom: 16px;
        opacity: 0.5;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal.active {
        display: flex;
    }
    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
    }
    .modal-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 16px;
    }
    .modal-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .modal-form textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-family: inherit;
        resize: vertical;
        min-height: 100px;
        box-sizing: border-box;
    }
    .modal-buttons {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }
    .btn-cancelar {
        padding: 10px 20px;
        background: #f0f0f0;
        color: #333;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }
    .btn-confirmar {
        padding: 10px 20px;
        background: #003366;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Gerenciar Justificativas</h2>
    {% if pendentes > 0 %}
    <span class="badge-pendentes">{{ pendentes }} pendente{{ pendentes|pluralize }}</span>
    {% endif %}
</div>

<div class="filters-card">
    <form method="GET" class="filters-row">
        <div class="filter-group">
            <label>Buscar Aluno</label>
            <input type="text" name="aluno" value="{{ busca_aluno }}" placeholder="Nome do aluno...">
        </div>
        <div class="filter-group">
            <label>Status</label>
            <select name="status">
                <option value="">Todos</option>
                <option value="PENDENTE" {% if status_filtro == 'PENDENTE' %}selected{% endif %}>Pendente</option>
                <option value="APROVADA" {% if status_filtro == 'APROVADA' %}selected{% endif %}>Aprovada</option>
                <option value="REJEITADA" {% if status_filtro == 'REJEITADA' %}selected{% endif %}>Rejeitada</option>
            </select>
        </div>
        <button type="submit" class="btn-filter">Filtrar</button>
        <a href="{% url 'secretaria_justificativas' %}" class="btn-limpar">Limpar</a>
    </form>
</div>

<div class="justificativas-card">
    {% if justificativas %}
    <div style="overflow-x: auto;">
        <table class="justificativas-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Aluno</th>
                    <th>Disciplina</th>
                    <th>Periodo</th>
                    <th>Status</th>
                    <th>Acoes</th>
                </tr>
            </thead>
            <tbody>
                {% for j in justificativas %}
                <tr>
                    <td>{{ j.data_solicitacao|date:"d/m/Y" }}</td>
                    <td>{{ j.aluno.nome }}</td>
                    <td>{{ j.disciplina.nome }}</td>
                    <td>{{ j.data_inicio|date:"d/m/Y" }} - {{ j.data_fim|date:"d/m/Y" }}</td>
                    <td>
                        <span class="status-badge status-{{ j.status|lower }}">
                            {{ j.get_status_display }}
                        </span>
                    </td>
                    <td>
                        <div class="action-btns">
                            {% if j.status == 'PENDENTE' %}
                            <button type="button" class="btn-aprovar" onclick="openModal({{ j.id }}, 'aprovar')">Aprovar</button>
                            <button type="button" class="btn-rejeitar" onclick="openModal({{ j.id }}, 'rejeitar')">Rejeitar</button>
                            {% endif %}
                            {% if j.documento %}
                            <a href="{{ j.documento.url }}" target="_blank" class="btn-ver-doc">Ver Doc</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                <tr style="background: #fafafa;">
                    <td colspan="6" style="padding: 10px 12px; font-size: 13px; color: #666;">
                        <strong>Justificativa:</strong> {{ j.justificativa|truncatechars:200 }}
                        {% if j.observacao %}
                        <br><strong>Observacao:</strong> {{ j.observacao }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5">
            <path d="M9 11l3 3L22 4"></path>
            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
        </svg>
        <p>Nenhuma justificativa encontrada.</p>
    </div>
    {% endif %}
</div>

<div id="actionModal" class="modal">
    <div class="modal-content">
        <h3 class="modal-title" id="modalTitle">Analisar Justificativa</h3>
        <form method="POST" class="modal-form" id="actionForm">
            {% csrf_token %}
            <input type="hidden" name="justificativa_id" id="justificativaId">
            <input type="hidden" name="acao" id="acao">
            <div>
                <label style="font-weight: 600; margin-bottom: 8px; display: block;">Observacao (opcional)</label>
                <textarea name="observacao" placeholder="Digite uma observacao..."></textarea>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-cancelar" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn-confirmar" id="btnConfirmar">Confirmar</button>
            </div>
        </form>
    </div>
</div>

<script>
function openModal(id, acao) {
    document.getElementById('justificativaId').value = id;
    document.getElementById('acao').value = acao;
    document.getElementById('modalTitle').textContent = acao === 'aprovar' ? 'Aprovar Justificativa' : 'Rejeitar Justificativa';
    document.getElementById('btnConfirmar').textContent = acao === 'aprovar' ? 'Aprovar' : 'Rejeitar';
    document.getElementById('btnConfirmar').style.background = acao === 'aprovar' ? '#28a745' : '#dc3545';
    document.getElementById('actionModal').classList.add('active');
}

function closeModal() {
    document.getElementById('actionModal').classList.remove('active');
}

document.getElementById('actionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}
