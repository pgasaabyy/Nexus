{% extends 'escola/base_admin.html' %}
{% load static %}

{% block title %}Turmas - Administração{% endblock %}
{% block nav_turmas %}active{% endblock %}
{% block page_title %}Gerenciar Turmas{% endblock %}

{% block extra_css %}
<style>
    .page-header { display: flex; justify-content: flex-end; margin-bottom: 24px; }
    .btn-primary { background: #092f76; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary:hover { background: #003D96; }
    .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; }
    .card-header { background: linear-gradient(90deg, #092f76, #003D96); color: white; padding: 16px 20px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .card-body { padding: 20px; overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { text-align: left; padding: 12px; background: #f8f8f8; border-bottom: 2px solid #e0e0e0; font-weight: 600; color: #333; font-size: 13px; }
    .data-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; }
    .data-table tr:hover { background-color: #f8fafc; }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; background: #e3f2fd; color: #1565c0; }
    .total-count { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 14px; }
    .actions { display: flex; gap: 8px; }
    .btn-sm { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .btn-edit { background: #8ed6d7; color: #092f76; }
    .btn-delete { background: #f8d7da; color: #721c24; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 24px; width: 100%; max-width: 500px; }
    .modal-header { font-size: 18px; font-weight: 600; color: #092f76; margin-bottom: 20px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #333; }
    .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; box-sizing: border-box; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #092f76; }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
    .btn-cancel { background: #e0e0e0; color: #333; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <button class="btn-primary" onclick="openModal('addModal')">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Nova Turma
    </button>
</div>

<div class="card">
    <div class="card-header">
        <span>Lista de Turmas</span>
        <span class="total-count">{{ turmas.count }} turmas</span>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Curso</th>
                    <th>Semestre</th>
                    <th>Turno</th>
                    <th>Alunos</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for turma in turmas %}
                <tr>
                    <td><strong>{{ turma.codigo }}</strong></td>
                    <td>{{ turma.curso.nome }}</td>
                    <td>{{ turma.semestre }}</td>
                    <td><span class="badge">{{ turma.turno }}</span></td>
                    <td>{{ turma.total_alunos }}</td>
                    <td class="actions">
                        <button class="btn-sm btn-edit" data-id="{{ turma.id }}" data-codigo="{{ turma.codigo }}" data-semestre="{{ turma.semestre }}" data-turno="{{ turma.turno }}" data-curso="{{ turma.curso.id }}">Editar</button>
                        <form method="post" style="display:inline;" onsubmit="return confirm('Excluir esta turma?');">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete">
                            <input type="hidden" name="turma_id" value="{{ turma.id }}">
                            <button type="submit" class="btn-sm btn-delete">Excluir</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" style="text-align:center; padding:30px; color:#666;">Nenhuma turma encontrada.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal" id="addModal">
    <div class="modal-content">
        <div class="modal-header">Nova Turma</div>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="add">
            <div class="form-row">
                <div class="form-group">
                    <label>Código *</label>
                    <input type="text" name="codigo" required placeholder="Ex: 1A-2024">
                </div>
                <div class="form-group">
                    <label>Semestre *</label>
                    <input type="text" name="semestre" required placeholder="Ex: 2024/1">
                </div>
            </div>
            <div class="form-group">
                <label>Curso *</label>
                <select name="curso" required>
                    <option value="">Selecione...</option>
                    {% for curso in cursos %}
                    <option value="{{ curso.id }}">{{ curso.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Turno *</label>
                <select name="turno" required>
                    {% for value, label in turnos %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('addModal')">Cancelar</button>
                <button type="submit" class="btn-primary">Criar Turma</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <div class="modal-header">Editar Turma</div>
        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit">
            <input type="hidden" name="turma_id" id="edit_turma_id">
            <div class="form-row">
                <div class="form-group">
                    <label>Código</label>
                    <input type="text" name="codigo" id="edit_codigo">
                </div>
                <div class="form-group">
                    <label>Semestre</label>
                    <input type="text" name="semestre" id="edit_semestre">
                </div>
            </div>
            <div class="form-group">
                <label>Curso</label>
                <select name="curso" id="edit_curso">
                    {% for curso in cursos %}
                    <option value="{{ curso.id }}">{{ curso.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Turno</label>
                <select name="turno" id="edit_turno">
                    {% for value, label in turnos %}
                    <option value="{{ value }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('editModal')">Cancelar</button>
                <button type="submit" class="btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<script>
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.btn-edit').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.getElementById('edit_turma_id').value = this.getAttribute('data-id');
            document.getElementById('edit_codigo').value = this.getAttribute('data-codigo');
            document.getElementById('edit_semestre').value = this.getAttribute('data-semestre');
            document.getElementById('edit_turno').value = this.getAttribute('data-turno');
            document.getElementById('edit_curso').value = this.getAttribute('data-curso');
            openModal('editModal');
        });
    });
    
    document.querySelectorAll('.modal').forEach(function(modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeModal(modal.id);
        });
    });
});
</script>
{% endblock %}
