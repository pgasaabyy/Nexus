{% extends 'escola/base_secretaria.html' %}
{% load static %}

{% block title %}Documentos - Secretaria{% endblock %}
{% block nav_documentos %}active{% endblock %}
{% block page_title %}Gestão de Documentos{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 24px;
        gap: 16px;
        flex-wrap: wrap;
    }
    .filters-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .filters-row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: flex-end;
    }
    .filter-group {
        flex: 1;
        min-width: 150px;
    }
    .filter-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
    }
    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }
    .btn-filter {
        padding: 10px 20px;
        background: #003366;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }
    .btn-filter:hover {
        background: #002244;
    }
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 24px;
    }
    @media (max-width: 992px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
    }
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    .data-table thead {
        background: #f8f9fa;
    }
    .data-table th {
        padding: 14px 16px;
        text-align: left;
        font-weight: 600;
        color: #333;
        font-size: 13px;
        border-bottom: 2px solid #e0e0e0;
    }
    .data-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
    }
    .data-table tbody tr:hover {
        background: #f8f9fa;
    }
    .status-tag {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    .status-tag.pendente {
        background: #fff3cd;
        color: #856404;
    }
    .status-tag.emitido {
        background: #cce5ff;
        color: #004085;
    }
    .status-tag.entregue {
        background: #d4edda;
        color: #155724;
    }
    .form-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .form-card-header {
        background: #003366;
        color: white;
        padding: 16px 20px;
        font-weight: 600;
    }
    .form-card-body {
        padding: 20px;
    }
    .form-group {
        margin-bottom: 16px;
    }
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
        font-size: 14px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }
    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }
    .btn-submit {
        width: 100%;
        padding: 12px;
        background: #003366;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .btn-submit:hover {
        background: #002244;
    }
    .empty-state {
        text-align: center;
        padding: 48px;
        color: #666;
    }
    .actions-cell {
        display: flex;
        gap: 8px;
    }
    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        text-decoration: none;
        transition: background 0.2s;
        border: none;
        cursor: pointer;
    }
    .action-btn.view {
        background: #e3f2fd;
        color: #003366;
    }
    .action-btn.view:hover {
        background: #bbdefb;
    }
    .action-btn.approve {
        background: #d4edda;
        color: #155724;
    }
    .action-btn.approve:hover {
        background: #c3e6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <p style="color: #666; margin: 0;">Gerencie solicitações de documentos dos alunos</p>
    </div>
</div>

<div class="filters-section">
    <form method="GET" class="filters-row">
        <div class="filter-group">
            <label for="aluno">Buscar Aluno</label>
            <input type="text" name="aluno" id="aluno" value="{{ busca_aluno }}" placeholder="Nome do aluno...">
        </div>
        <div class="filter-group" style="max-width: 180px;">
            <label for="tipo">Tipo</label>
            <select name="tipo" id="tipo">
                <option value="TODOS">Todos os tipos</option>
                {% for tipo in tipos_choices %}
                <option value="{{ tipo.0 }}" {% if tipo_filtro == tipo.0 %}selected{% endif %}>{{ tipo.1 }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group" style="max-width: 150px;">
            <label for="status">Status</label>
            <select name="status" id="status">
                <option value="TODOS">Todos</option>
                {% for status in status_choices %}
                <option value="{{ status.0 }}" {% if status_filtro == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn-filter">Filtrar</button>
    </form>
</div>

<div class="content-grid">
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Aluno</th>
                    <th>Tipo</th>
                    <th>Data Solicitação</th>
                    <th>Status</th>
                    <th>Arquivo</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documentos %}
                <tr>
                    <td><strong>{{ doc.aluno.nome }}</strong></td>
                    <td>{{ doc.get_tipo_display }}</td>
                    <td>{{ doc.data_solicitacao|date:"d/m/Y H:i" }}</td>
                    <td>
                        <span class="status-tag {% if doc.status == 'PENDENTE' %}pendente{% elif doc.status == 'EMITIDO' %}emitido{% else %}entregue{% endif %}">
                            {{ doc.get_status_display }}
                        </span>
                    </td>
                    <td>
                        {% if doc.arquivo %}
                        <span style="color:#2e7d32;font-size:12px;display:flex;align-items:center;gap:4px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            Enviado
                        </span>
                        {% else %}
                        <span style="color:#999;font-size:12px;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn view" title="Visualizar" onclick="visualizarDocumento({{ doc.id }})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            {% if doc.status == 'PENDENTE' %}
                            <button class="action-btn approve" title="Emitir" onclick="abrirModalEmitir({{ doc.id }}, '{{ doc.get_tipo_display }}', '{{ doc.aluno.nome }}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </button>
                            {% elif doc.status == 'EMITIDO' %}
                            <button class="action-btn upload" style="background:#e3f2fd;color:#1565c0;" title="Enviar/Atualizar Documento" onclick="abrirModalEnviar({{ doc.id }}, '{{ doc.get_tipo_display }}', '{{ doc.aluno.nome }}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </button>
                            <button class="action-btn" style="background:#fff3cd;color:#856404;" title="Confirmar Entrega" onclick="confirmarEntrega({{ doc.id }})">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            </button>
                            {% elif doc.status == 'ENTREGUE' %}
                            {% if not doc.arquivo %}
                            <button class="action-btn upload" style="background:#e3f2fd;color:#1565c0;" title="Enviar Documento" onclick="abrirModalEnviar({{ doc.id }}, '{{ doc.get_tipo_display }}', '{{ doc.aluno.nome }}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </button>
                            {% endif %}
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <p style="margin-top: 16px;">Nenhum documento encontrado</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="form-card">
        <div class="form-card-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px;">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Nova Solicitação
        </div>
        <div class="form-card-body">
            <form method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <label for="aluno_id">Aluno</label>
                    <select name="aluno_id" id="aluno_id" required>
                        <option value="">Selecione um aluno</option>
                        {% for aluno in alunos %}
                        <option value="{{ aluno.id }}">{{ aluno.nome }} ({{ aluno.matricula }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipo">Tipo de Documento</label>
                    <select name="tipo" id="tipo_doc" required>
                        <option value="">Selecione o tipo</option>
                        {% for tipo in tipos_choices %}
                        <option value="{{ tipo.0 }}">{{ tipo.1 }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="descricao">Observações</label>
                    <textarea name="descricao" id="descricao" placeholder="Observações adicionais (opcional)"></textarea>
                </div>
                <button type="submit" class="btn-submit">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="12" y1="18" x2="12" y2="12"></line>
                        <line x1="9" y1="15" x2="15" y2="15"></line>
                    </svg>
                    Solicitar Documento
                </button>
            </form>
        </div>
    </div>
</div>

<div id="modalVisualizar" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width:500px;">
        <div class="modal-header">
            <h3>Detalhes do Documento</h3>
            <button class="modal-close" onclick="fecharModal('modalVisualizar')">&times;</button>
        </div>
        <div class="modal-body" id="modalVisualizarBody">
            <div class="loading">Carregando...</div>
        </div>
    </div>
</div>

<div id="modalEmitir" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width:450px;">
        <div class="modal-header">
            <h3>Emitir Documento</h3>
            <button class="modal-close" onclick="fecharModal('modalEmitir')">&times;</button>
        </div>
        <form id="formEmitir" enctype="multipart/form-data">
            <div class="modal-body">
                <p id="emitirInfo" style="margin-bottom:16px;"></p>
                <div class="form-group">
                    <label for="arquivoDoc">Anexar Documento (PDF)</label>
                    <input type="file" name="arquivo" id="arquivoDoc" accept=".pdf,.doc,.docx">
                    <small style="color:#666;font-size:12px;display:block;margin-top:4px;">Opcional: anexe o documento digital para download do aluno</small>
                </div>
            </div>
            <div class="modal-footer" style="padding:16px 20px;border-top:1px solid #eee;display:flex;gap:12px;justify-content:flex-end;">
                <button type="button" class="btn-cancel" onclick="fecharModal('modalEmitir')">Cancelar</button>
                <button type="submit" class="btn-submit" style="width:auto;">Emitir Documento</button>
            </div>
        </form>
    </div>
</div>

<div id="modalEnviar" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width:450px;">
        <div class="modal-header">
            <h3>Enviar Documento ao Aluno</h3>
            <button class="modal-close" onclick="fecharModal('modalEnviar')">&times;</button>
        </div>
        <form id="formEnviar" enctype="multipart/form-data">
            <div class="modal-body">
                <p id="enviarInfo" style="margin-bottom:16px;"></p>
                <div class="form-group">
                    <label for="arquivoEnviar">Selecionar Documento (PDF)</label>
                    <input type="file" name="arquivo" id="arquivoEnviar" accept=".pdf,.doc,.docx" required>
                    <small style="color:#666;font-size:12px;display:block;margin-top:4px;">Selecione o documento para disponibilizar ao aluno para download</small>
                </div>
            </div>
            <div class="modal-footer" style="padding:16px 20px;border-top:1px solid #eee;display:flex;gap:12px;justify-content:flex-end;">
                <button type="button" class="btn-cancel" onclick="fecharModal('modalEnviar')">Cancelar</button>
                <button type="submit" class="btn-submit" style="width:auto;">Enviar Documento</button>
            </div>
        </form>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-content {
        background: white;
        border-radius: 12px;
        width: 90%;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .modal-header {
        background: #003366;
        color: white;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .modal-header h3 { margin: 0; }
    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
    }
    .modal-body {
        padding: 20px;
    }
    .detail-row {
        display: flex;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .detail-label {
        font-weight: 600;
        width: 140px;
        color: #666;
    }
    .detail-value {
        flex: 1;
        color: #333;
    }
    .btn-cancel {
        padding: 10px 20px;
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
    }
    .btn-cancel:hover { background: #e0e0e0; }
    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>

<script>
let docIdAtual = null;
let docIdEnviar = null;

function visualizarDocumento(docId) {
    document.getElementById('modalVisualizar').style.display = 'flex';
    document.getElementById('modalVisualizarBody').innerHTML = '<div class="loading">Carregando...</div>';
    
    fetch(`/dashboard/secretaria/documentos/${docId}/visualizar/`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const doc = data.documento;
                let html = `
                    <div class="detail-row"><span class="detail-label">Aluno:</span><span class="detail-value">${doc.aluno}</span></div>
                    <div class="detail-row"><span class="detail-label">Matricula:</span><span class="detail-value">${doc.matricula}</span></div>
                    <div class="detail-row"><span class="detail-label">Turma:</span><span class="detail-value">${doc.turma}</span></div>
                    <div class="detail-row"><span class="detail-label">Tipo:</span><span class="detail-value">${doc.tipo}</span></div>
                    <div class="detail-row"><span class="detail-label">Solicitado em:</span><span class="detail-value">${doc.data_solicitacao}</span></div>
                    <div class="detail-row"><span class="detail-label">Status:</span><span class="detail-value">${doc.status}</span></div>
                `;
                if (doc.data_emissao && doc.data_emissao != '-') {
                    html += `<div class="detail-row"><span class="detail-label">Emitido em:</span><span class="detail-value">${doc.data_emissao}</span></div>`;
                }
                if (doc.descricao) {
                    html += `<div class="detail-row"><span class="detail-label">Observacoes:</span><span class="detail-value">${doc.descricao}</span></div>`;
                }
                if (doc.arquivo_url) {
                    html += `<div class="detail-row"><span class="detail-label">Arquivo:</span><span class="detail-value"><a href="${doc.arquivo_url}" target="_blank" style="color:#003366;">Baixar Documento</a></span></div>`;
                }
                document.getElementById('modalVisualizarBody').innerHTML = html;
            } else {
                document.getElementById('modalVisualizarBody').innerHTML = '<p style="color:red;">Erro ao carregar documento.</p>';
            }
        });
}

function abrirModalEmitir(docId, tipo, aluno) {
    docIdAtual = docId;
    document.getElementById('emitirInfo').innerHTML = `<strong>Tipo:</strong> ${tipo}<br><strong>Aluno:</strong> ${aluno}`;
    document.getElementById('modalEmitir').style.display = 'flex';
}

function abrirModalEnviar(docId, tipo, aluno) {
    docIdEnviar = docId;
    document.getElementById('enviarInfo').innerHTML = `<strong>Tipo:</strong> ${tipo}<br><strong>Aluno:</strong> ${aluno}`;
    document.getElementById('arquivoEnviar').value = '';
    document.getElementById('modalEnviar').style.display = 'flex';
}

function fecharModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function confirmarEntrega(docId) {
    if (!confirm('Confirmar que o documento foi entregue ao aluno?')) return;
    
    fetch(`/dashboard/secretaria/documentos/${docId}/confirmar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Erro ao confirmar entrega.');
        }
    });
}

document.getElementById('formEmitir').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(`/dashboard/secretaria/documentos/${docIdAtual}/emitir/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Erro ao emitir documento.');
        }
    });
});

document.getElementById('formEnviar').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(`/dashboard/secretaria/documentos/${docIdEnviar}/enviar/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.error || 'Erro ao enviar documento.');
        }
    });
});

document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
});
</script>
{% endblock %}
