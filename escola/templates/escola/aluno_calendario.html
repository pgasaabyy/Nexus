{% extends 'escola/base_aluno.html' %}
{% load static %}

{% block title %}Calendário - Aluno{% endblock %}
{% block nav_calendario %}active{% endblock %}
{% block page_title %}Calendário Escolar{% endblock %}

{% block extra_css %}
<style>
    .calendar-page {
        max-width: 1100px;
    }
    .calendar-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 24px;
    }
    @media (max-width: 900px) {
        .calendar-container {
            grid-template-columns: 1fr;
        }
    }
    .calendar-main-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .calendar-header {
        padding: 20px 24px;
        background: #003366;
        color: white;
    }
    .calendar-header-content {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .calendar-title {
        display: none;
    }
    .month-nav {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .month-nav-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: rgba(255,255,255,0.2);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    .month-nav-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    .current-month {
        font-size: 16px;
        font-weight: 500;
        min-width: 150px;
        text-align: center;
    }
    .calendar-body {
        padding: 24px;
    }
    .weekdays-row {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 12px;
    }
    .weekday-cell {
        text-align: center;
        font-weight: 600;
        color: #666;
        font-size: 13px;
        padding: 8px;
    }
    .days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }
    .day-cell {
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        font-size: 15px;
    }
    .day-cell:hover {
        background: #f0f0f0;
    }
    .day-cell.other-month {
        color: #ccc;
    }
    .day-cell.today {
        background: #003366;
        color: white;
        font-weight: 600;
    }
    .day-cell.has-event::after {
        content: '';
        position: absolute;
        bottom: 6px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #003366;
    }
    .day-cell.today.has-event::after {
        background: white;
    }
    .day-cell.holiday {
        background: #ffebee;
        color: #c62828;
    }
    .events-sidebar {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .events-header {
        padding: 16px 20px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
    }
    .events-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }
    .events-list {
        padding: 16px;
        max-height: 500px;
        overflow-y: auto;
    }
    .event-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        background: #f8f9fa;
        transition: transform 0.2s;
    }
    .event-item:hover {
        transform: translateX(4px);
    }
    .event-item:last-child {
        margin-bottom: 0;
    }
    .event-date-badge {
        background: #003366;
        color: white;
        padding: 8px;
        border-radius: 8px;
        text-align: center;
        min-width: 50px;
    }
    .event-date-day {
        font-size: 18px;
        font-weight: 700;
    }
    .event-date-month {
        font-size: 11px;
        text-transform: uppercase;
    }
    .event-info {
        flex: 1;
    }
    .event-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
    }
    .event-type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .event-type-badge.feriado { background: #ffebee; color: #c62828; }
    .event-type-badge.prova { background: #fff3e0; color: #ef6c00; }
    .event-type-badge.trabalho { background: #e8f5e9; color: #2e7d32; }
    .event-type-badge.evento { background: #e3f2fd; color: #1565c0; }
    .event-type-badge.reuniao { background: #f3e5f5; color: #7b1fa2; }
    .legend-section {
        padding: 16px;
        border-top: 1px solid #e0e0e0;
    }
    .legend-title {
        font-size: 13px;
        font-weight: 600;
        color: #666;
        margin-bottom: 12px;
    }
    .legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #666;
    }
    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    .empty-events {
        text-align: center;
        padding: 32px 16px;
        color: #666;
    }
    .empty-events svg {
        margin-bottom: 12px;
        color: #ccc;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-page">
    <div class="calendar-container">
        <div class="calendar-main-card">
            <div class="calendar-header">
                <div class="calendar-header-content">
                    <div class="month-nav">
                        <button class="month-nav-btn" id="prevMonth">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <span class="current-month" id="currentMonth">Dezembro 2025</span>
                        <button class="month-nav-btn" id="nextMonth">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="calendar-body">
                <div class="weekdays-row">
                    <div class="weekday-cell">Dom</div>
                    <div class="weekday-cell">Seg</div>
                    <div class="weekday-cell">Ter</div>
                    <div class="weekday-cell">Qua</div>
                    <div class="weekday-cell">Qui</div>
                    <div class="weekday-cell">Sex</div>
                    <div class="weekday-cell">Sáb</div>
                </div>
                <div class="days-grid" id="daysGrid"></div>
            </div>
        </div>
        
        <div class="events-sidebar">
            <div class="events-header">
                <h3>Próximos Eventos</h3>
            </div>
            <div class="events-list" id="eventsList">
                <!-- Events will be populated by JavaScript -->
            </div>
            <div class="legend-section">
                <div class="legend-title">Legenda</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #003366;"></div>
                        <span>Hoje</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #c62828;"></div>
                        <span>Feriado</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #1565c0;"></div>
                        <span>Evento</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const eventos = {{ eventos_json|safe }};
    const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();
    
    function renderCalendar() {
        const daysGrid = document.getElementById('daysGrid');
        const currentMonthLabel = document.getElementById('currentMonth');
        
        currentMonthLabel.textContent = meses[currentMonth] + ' ' + currentYear;
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();
        
        let html = '';
        
        // Empty cells for days before the first of the month
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="day-cell other-month"></div>';
        }
        
        // Days of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = currentYear + '-' + String(currentMonth + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            const hasEvent = eventos.some(e => e.data === dateStr);
            const isHoliday = eventos.some(e => e.data === dateStr && e.tipo === 'feriado');
            const isToday = day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
            
            let classes = 'day-cell';
            if (isToday) classes += ' today';
            if (hasEvent) classes += ' has-event';
            if (isHoliday) classes += ' holiday';
            
            html += '<div class="' + classes + '" data-date="' + dateStr + '">' + day + '</div>';
        }
        
        daysGrid.innerHTML = html;
    }
    
    function renderEvents() {
        const eventsList = document.getElementById('eventsList');
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const upcomingEvents = eventos
            .filter(e => new Date(e.data) >= today)
            .sort((a, b) => new Date(a.data) - new Date(b.data))
            .slice(0, 5);
        
        if (upcomingEvents.length === 0) {
            eventsList.innerHTML = `
                <div class="empty-events">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <p>Nenhum evento próximo</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        upcomingEvents.forEach(evento => {
            const date = new Date(evento.data + 'T00:00:00');
            const day = date.getDate();
            const month = meses[date.getMonth()].substring(0, 3).toUpperCase();
            
            html += `
                <div class="event-item">
                    <div class="event-date-badge">
                        <div class="event-date-day">${day}</div>
                        <div class="event-date-month">${month}</div>
                    </div>
                    <div class="event-info">
                        <div class="event-title">${evento.titulo}</div>
                        <span class="event-type-badge ${evento.tipo}">${evento.tipo}</span>
                    </div>
                </div>
            `;
        });
        
        eventsList.innerHTML = html;
    }
    
    document.getElementById('prevMonth').addEventListener('click', function() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar();
    });
    
    document.getElementById('nextMonth').addEventListener('click', function() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar();
    });
    
    renderCalendar();
    renderEvents();
});
</script>
{% endblock %}
