{% extends 'escola/base_secretaria.html' %}
{% load static %}

{% block title %}Calendário Acadêmico - Secretaria{% endblock %}
{% block nav_calendario %}active{% endblock %}
{% block page_title %}Calendário Acadêmico{% endblock %}

{% block extra_css %}
<style>
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .month-nav { display: flex; align-items: center; gap: 16px; }
    .month-title { font-size: 18px; font-weight: 600; color: #003366; min-width: 180px; text-align: center; }
    .btn-nav { width: 32px; height: 32px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
    .btn-nav:hover { background: #f0f0f0; border-color: #003366; }
    .content-card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 24px; max-width: 800px; }
    .calendar-wrapper { display: grid; grid-template-columns: repeat(7, 1fr); }
    .weekday { padding: 8px 4px; text-align: center; font-weight: 600; color: #666; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; font-size: 12px; }
    .calendar-days { display: contents; }
    .cal-day { min-height: 70px; max-height: 90px; padding: 6px; border: 1px solid #f0f0f0; position: relative; cursor: pointer; transition: background 0.2s; overflow: hidden; }
    .cal-day:hover { background: #f8f9fa; }
    .cal-day.other-month { background: #fafafa; }
    .cal-day.other-month .day-number { color: #ccc; }
    .cal-day.today { background: #e3f2fd; }
    .cal-day.today .day-number { background: #003366; color: white; }
    .day-number { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; font-weight: 600; font-size: 12px; color: #333; }
    .event-dot { display: block; margin-top: 2px; padding: 1px 4px; border-radius: 3px; font-size: 9px; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
    .event-reuniao { background: #28a745; }
    .event-feriado { background: #dc3545; }
    .event-prova { background: #ffc107; color: #333; }
    .event-outro { background: #6c757d; }
    .events-list { margin-top: 24px; max-width: 800px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; }
    .card-header h3 { font-size: 15px; font-weight: 600; color: #333; margin: 0; }
    .card-body { padding: 16px; }
    .event-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid #f0f0f0; }
    .event-item:last-child { border-bottom: none; }
    .event-date-box { width: 45px; height: 45px; background: #003366; color: white; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; }
    .event-date-box .day-num { font-size: 16px; font-weight: 700; line-height: 1; }
    .event-date-box .month-name { font-size: 10px; text-transform: uppercase; }
    .event-info { flex: 1; }
    .event-info h4 { margin: 0 0 4px 0; color: #333; font-size: 14px; }
    .event-info p { margin: 0; color: #666; font-size: 12px; }
    .event-type { padding: 4px 10px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .empty-message { text-align: center; padding: 30px; color: #666; }
    .btn-add-event { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; background: #003366; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; transition: background 0.2s; }
    .btn-add-event:hover { background: #002244; }
</style>
{% endblock %}

{% block content %}
<div class="calendar-header">
    <div class="month-nav">
        <button class="btn-nav" id="prevMonth">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <h2 class="month-title" id="monthYear">Dezembro 2025</h2>
        <button class="btn-nav" id="nextMonth">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        </button>
    </div>
    <a href="{% url 'secretaria_evento_adicionar' %}" class="btn-add-event">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Novo Evento
    </a>
</div>

<div class="content-card">
    <div class="calendar-wrapper">
        <div class="weekday">Dom</div>
        <div class="weekday">Seg</div>
        <div class="weekday">Ter</div>
        <div class="weekday">Qua</div>
        <div class="weekday">Qui</div>
        <div class="weekday">Sex</div>
        <div class="weekday">Sáb</div>
        <div id="calendarDays" class="calendar-days"></div>
    </div>
</div>

<div class="content-card events-list">
    <div class="card-header">
        <h3>Próximos Eventos</h3>
    </div>
    <div class="card-body">
        {% if eventos %}
        {% for evento in eventos|slice:":5" %}
        <div class="event-item">
            <div class="event-date-box">
                <span class="day-num">{{ evento.data|date:"d" }}</span>
                <span class="month-name">{{ evento.data|date:"M" }}</span>
            </div>
            <div class="event-info">
                <h4>{{ evento.titulo }}</h4>
                <p>{{ evento.descricao|default:"Sem descrição"|truncatewords:15 }}</p>
            </div>
            <span class="event-type event-{{ evento.tipo|lower }}">{{ evento.get_tipo_display|default:evento.tipo }}</span>
        </div>
        {% endfor %}
        {% else %}
        <p class="empty-message">Nenhum evento agendado.</p>
        {% endif %}
    </div>
</div>

<script>
const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
const monthNamesShort = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
let currentDate = new Date();

const eventos = {{ eventos_json|safe }};

function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;
    
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    let html = '';
    
    for (let i = firstDay - 1; i >= 0; i--) {
        html += `<div class="cal-day other-month"><span class="day-number">${daysInPrevMonth - i}</span></div>`;
    }
    
    const today = new Date();
    for (let day = 1; day <= daysInMonth; day++) {
        const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        const dayEvents = eventos.filter(e => e.data === dateStr);
        let eventsHtml = '';
        dayEvents.slice(0, 2).forEach(e => {
            const typeClass = e.tipo ? `event-${e.tipo.toLowerCase()}` : 'event-outro';
            eventsHtml += `<span class="event-dot ${typeClass}">${e.titulo}</span>`;
        });
        if (dayEvents.length > 2) {
            eventsHtml += `<span class="event-dot event-outro">+${dayEvents.length - 2}</span>`;
        }
        
        html += `<div class="cal-day${isToday ? ' today' : ''}"><span class="day-number">${day}</span>${eventsHtml}</div>`;
    }
    
    const totalCells = firstDay + daysInMonth;
    const remainingCells = (7 - (totalCells % 7)) % 7;
    for (let i = 1; i <= remainingCells; i++) {
        html += `<div class="cal-day other-month"><span class="day-number">${i}</span></div>`;
    }
    
    document.getElementById('calendarDays').innerHTML = html;
}

document.getElementById('prevMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
});

document.getElementById('nextMonth').addEventListener('click', () => {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
});

renderCalendar();
</script>
{% endblock %}
